language: python
dist: trusty
sudo: required

python:
  - 3.6

cache: pip

services:
  - mysql

addons:
  hosts:
    - test_site

git:
  depth: 1

install:
  - source ~/.nvm/nvm.sh
  - nvm install v8.10.0

  - wget https://raw.githubusercontent.com/frappe/bench/master/playbooks/install.py
  - sudo -H python install.py --develop --user travis --without-bench-setup
  - git clone https://github.com/adityahase/bench --depth=1 --branch=fix-print my-bench
  - pip install -e ./my-bench

  - mysql -u root -ptravis -e "create database test_frappe"
  - mysql -u root -ptravis -e "USE mysql; CREATE USER 'test_frappe'@'localhost' IDENTIFIED BY 'test_frappe'; FLUSH PRIVILEGES;"
  - mysql -u root -ptravis -e "USE mysql; GRANT ALL PRIVILEGES ON \`test_frappe\`.* TO 'test_frappe'@'localhost'; FLUSH PRIVILEGES;"

  - mysql -u root -ptravis -e "SHOW VARIABLES LIKE '%server%'"
  - mysql -u root -ptravis -e "SELECT user, host, password FROM mysql.user"
  - mysql -u root -ptravis -e "SHOW DATABASES"

  - rm $TRAVIS_BUILD_DIR/.git/shallow
  - cd ~/ && bench init frappe-bench --python $(which python)  --verbose --skip-assets --frappe-path $TRAVIS_BUILD_DIR
  - cp -r $TRAVIS_BUILD_DIR/test_sites/test_site ~/frappe-bench/sites/

before_script:
  - cd ~/frappe-bench
  - sed -i 's/redis_socketio:/# redis_socketio:/g' Procfile
  - sed -i 's/socketio:/# socketio:/g' Procfile
  - sed -i 's/watch:/# watch:/g' Procfile
  - sed -i 's/schedule:/# schedule:/g' Procfile
  - bench start &
  - sleep 10

script:
  - bench --site test_site --force reinstall --yes
  - bench --site test_site scheduler disable
  - bench --site test_site run-tests --coverage
